<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waypoints</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Load User's Airport Data -->
    <!-- Ensure airports_data.js is in the same directory -->
    <script src="airports_data.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Tooltip animation for copy feedback */
        .fade-in-out {
            animation: fadeInOut 2s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-xl shadow-lg w-full max-w-md overflow-hidden">
        <!-- Header -->
        <div class="bg-blue-600 p-6 text-center">
            <h1 class="text-2xl font-bold text-white flex items-center justify-center gap-2">
                <i class="ph ph-map-trifold"></i> Waypoints
            </h1>
        </div>

        <!-- Content -->
        <div class="p-6">
            <form id="geoForm" class="space-y-4">
                <div>
                    <textarea 
                        id="address" 
                        rows="2" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition resize-none"
                        placeholder="e.g. Kitty Hawk, North Carolina"
                        required></textarea>
                </div>

                <button 
                    type="submit" 
                    id="submitBtn"
                    class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>Get Coordinates</span>
                    <i class="ph ph-magnifying-glass"></i>
                </button>
            </form>

            <!-- Loading State -->
            <div id="loading" class="hidden mt-6 text-center text-gray-500 flex flex-col items-center">
                <div class="loader mb-2"></div>
                <p class="text-sm">Searching global database...</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden mt-6 bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <div class="flex items-center">
                    <i class="ph ph-warning-circle text-red-500 text-xl mr-2"></i>
                    <p class="text-red-700 font-medium" id="errorText">Address not found.</p>
                </div>
            </div>

            <!-- Result Card -->
            <div id="resultCard" class="hidden mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4 relative">
                
                <div class="space-y-3 mb-4">

                    <!-- Bubble 0: Found Address (Click to Copy) -->
                    <div id="addressBubble" class="group bg-white p-3 rounded shadow-sm border border-gray-100 cursor-pointer hover:bg-blue-50 hover:border-blue-200 transition relative">
                        <div class="flex justify-between items-start gap-2">
                            <p id="foundAddress" class="text-sm text-gray-700 italic leading-relaxed font-medium break-words"></p>
                            <i class="ph ph-copy text-gray-400 group-hover:text-blue-500 flex-shrink-0 mt-1"></i>
                        </div>
                        <div id="copyFeedbackAddress" class="hidden absolute top-[-30px] right-0 bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg z-10">Copied!</div>
                    </div>
                    
                    <!-- Bubble 1: DDM (Degrees Decimal Minutes) -->
                    <div id="dmsBubble" class="group bg-white p-3 rounded shadow-sm border border-gray-100 cursor-pointer hover:bg-blue-50 hover:border-blue-200 transition relative">
                        <div class="flex justify-between items-center h-full">
                            <div>
                                <div class="font-mono font-bold text-gray-800 text-lg leading-tight">
                                    <div id="dmsLat" class="whitespace-pre">--</div>
                                    <div id="dmsLon" class="whitespace-pre">--</div>
                                </div>
                            </div>
                            <i class="ph ph-copy text-gray-400 group-hover:text-blue-500 flex-shrink-0 ml-auto"></i>
                        </div>
                        <div id="copyFeedbackDms" class="hidden absolute top-[-30px] right-0 bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg z-10">Copied!</div>
                    </div>

                    <!-- Bubble 2: ForeFlight (Decimal / Decimal) -->
                    <div id="foreflightBubble" class="group bg-white p-3 rounded shadow-sm border border-gray-100 cursor-pointer hover:bg-blue-50 hover:border-blue-200 transition relative">
                         <div class="flex justify-between items-center h-full">
                            <div>
                                <div id="foreflightDisplay" class="font-mono font-bold text-blue-600 text-lg break-all">--</div>
                            </div>
                            <i class="ph ph-copy text-gray-400 group-hover:text-blue-500 flex-shrink-0 ml-auto"></i>
                        </div>
                        <div id="copyFeedbackForeflight" class="hidden absolute top-[-30px] right-0 bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg z-10">Copied!</div>
                    </div>

                </div>

                <!-- Nearest Airports Section -->
                <div id="airportSection" class="hidden mb-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Closest Airports</h3>
                    <div id="airportList" class="space-y-2">
                        <!-- Populated by JS -->
                    </div>
                </div>

            </div>
        </div>
        
        <div class="bg-gray-50 px-6 py-3 border-t border-gray-100">
            <p class="text-xs text-center text-gray-400">Powered by OpenStreetMap & Nominatim</p>
        </div>
    </div>

    <script>
        const form = document.getElementById('geoForm');
        const addressInput = document.getElementById('address');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const resultCard = document.getElementById('resultCard');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        const dmsLat = document.getElementById('dmsLat');
        const dmsLon = document.getElementById('dmsLon');
        const foreflightDisplay = document.getElementById('foreflightDisplay');
        
        const foundAddress = document.getElementById('foundAddress');
        const addressBubble = document.getElementById('addressBubble');
        const dmsBubble = document.getElementById('dmsBubble');
        const foreflightBubble = document.getElementById('foreflightBubble');

        const airportSection = document.getElementById('airportSection');
        const airportList = document.getElementById('airportList');

        // Haversine Formula for Spherical Earth
        function getDistanceNM(lat1, lon1, lat2, lon2) {
            const R = 3440.065; // Earth Radius in Nautical Miles
            
            const toRad = (value) => value * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function findClosestAirports(lat, lon) {
            if (typeof AIRPORTS_DATA === 'undefined' || !Array.isArray(AIRPORTS_DATA)) {
                console.warn("AIRPORTS_DATA not found. Make sure airports_data.js is loaded.");
                return [];
            }

            // Map distances
            const airportsWithDist = AIRPORTS_DATA.map(airport => {
                // Schema: [gps_code, latitude_deg, longitude_deg, longest_runway_ft, name]
                const dist = getDistanceNM(lat, lon, airport[1], airport[2]);
                return {
                    code: airport[0],
                    lat: airport[1],
                    lon: airport[2],
                    runway: airport[3],
                    name: airport[4],
                    dist: dist
                };
            });

            // Sort by distance ascending
            airportsWithDist.sort((a, b) => a.dist - b.dist);

            // Return top 3
            return airportsWithDist.slice(0, 3);
        }

        function renderAirports(airports, originLat, originLon) {
            airportList.innerHTML = '';
            
            if (airports.length === 0) {
                airportSection.classList.add('hidden');
                return;
            }

            airports.forEach(apt => {
                const item = document.createElement('div');
                item.className = "bg-gray-50 p-2 rounded border border-gray-100 flex items-center justify-between";
                
                // Format runway length (e.g. 10000 -> 10,000)
                const rwy = apt.runway ? `${apt.runway.toLocaleString()}ft` : "N/A";

                // Google Maps Driving Directions: From Airport TO Waypoint
                // Origin: Airport, Dest: Waypoint
                const driveLink = `https://www.google.com/maps/dir/?api=1&origin=${apt.lat},${apt.lon}&destination=${originLat},${originLon}&travelmode=driving`;
                
                // AirNav Link
                const airnavLink = `https://www.airnav.com/airport/${apt.code}`;

                item.innerHTML = `
                    <div class="flex-1 min-w-0 pr-2">
                        <div class="flex items-center gap-2">
                            <a href="${airnavLink}" target="_blank" class="text-blue-600 font-bold hover:underline font-mono text-sm">${apt.code}</a>
                            <span class="text-xs text-gray-500 font-mono">${apt.dist.toFixed(1)}nm</span>
                        </div>
                        <div class="text-xs text-gray-800 truncate" title="${apt.name}">${apt.name}</div>
                        <div class="text-[10px] text-gray-400">Rwy: ${rwy}</div>
                    </div>
                    <a href="${driveLink}" target="_blank" title="Drive from Airport to Waypoint" class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-white border border-gray-200 rounded-full text-blue-600 hover:bg-blue-50 transition">
                        <i class="ph ph-car text-lg"></i>
                    </a>
                `;
                airportList.appendChild(item);
            });
            
            airportSection.classList.remove('hidden');
        }

        // Updated Function: Degrees Decimal Minutes (Garmin format)
        // Added space after N/S direction
        function toDDM(coordinate, isLat) {
            const absolute = Math.abs(coordinate);
            const degrees = Math.floor(absolute);
            // Get remainder as decimal minutes
            const minutesDecimal = (absolute - degrees) * 60;
            
            // Format minutes to 2 decimal places (hundredths of a minute)
            const minutesStr = minutesDecimal.toFixed(2).padStart(5, '0');

            let direction = "";
            let degreesStr = degrees.toString();

            if (isLat) {
                // Added single space here
                direction = coordinate >= 0 ? "N " : "S ";
            } else {
                direction = coordinate >= 0 ? "E" : "W";
                degreesStr = degrees.toString().padStart(3, '0'); 
            }

            // Compact format with space for Lat: N 36°45.50' vs W122°45.50'
            return `${direction}${degreesStr}°${minutesStr}'`;
        }

        function toForeFlightDecimal(lat, lon) {
            return `${lat.toFixed(5)}/${lon.toFixed(5)}`;
        }

        // Generic Copy Function
        function setupCopy(element, textGetter, feedbackId) {
            const feedbackEl = document.getElementById(feedbackId);
            
            element.addEventListener('click', () => {
                const textToCopy = textGetter();
                
                if(textToCopy && !textToCopy.includes('--')) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        feedbackEl.classList.remove('hidden');
                        feedbackEl.classList.add('fade-in-out');
                        
                        setTimeout(() => {
                            feedbackEl.classList.add('hidden');
                            feedbackEl.classList.remove('fade-in-out');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
                }
            });
        }

        // Setup Copy Listeners
        setupCopy(addressBubble, () => foundAddress.textContent, 'copyFeedbackAddress');
        
        setupCopy(dmsBubble, () => {
            return `${dmsLat.textContent}\n${dmsLon.textContent}`;
        }, 'copyFeedbackDms');
        
        setupCopy(foreflightBubble, () => foreflightDisplay.textContent, 'copyFeedbackForeflight');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const address = addressInput.value.trim();
            
            if (!address) return;

            // Reset UI
            errorMessage.classList.add('hidden');
            resultCard.classList.add('hidden');
            airportSection.classList.add('hidden');
            loading.classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.querySelector('span').textContent = "Searching...";

            try {
                // Request address details to help build AirNav link
                const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(address)}&limit=1`;

                const response = await fetch(url, {
                    headers: {
                        'Accept-Language': 'en-US,en;q=0.5' 
                    }
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();

                if (data.length === 0) {
                    throw new Error('Address could not be found. Please try being more specific.');
                }

                const result = data[0];
                const lat = parseFloat(result.lat);
                const lon = parseFloat(result.lon);

                // Bubble 1: DDM (Degrees Decimal Minutes)
                dmsLat.textContent = toDDM(lat, true);
                dmsLon.textContent = toDDM(lon, false);

                // Bubble 2: ForeFlight
                foreflightDisplay.textContent = toForeFlightDecimal(lat, lon);

                // Address Bubble
                foundAddress.textContent = result.display_name;
                
                // --- Calculate Closest Airports ---
                const closestAirports = findClosestAirports(lat, lon);
                renderAirports(closestAirports, lat, lon);

                resultCard.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                errorText.textContent = error.message;
                errorMessage.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.querySelector('span').textContent = "Get Coordinates";
            }
        });
    </script>
</body>
</html>