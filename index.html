<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waypoints</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Tooltip animation for copy feedback */
        .fade-in-out {
            animation: fadeInOut 2s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-xl shadow-lg w-full max-w-md overflow-hidden">
        <!-- Header -->
        <div class="bg-blue-600 p-6 text-center">
            <h1 class="text-2xl font-bold text-white flex items-center justify-center gap-2">
                <i class="ph ph-map-trifold"></i> Waypoints
            </h1>
        </div>

        <!-- Content -->
        <div class="p-6">
            <form id="geoForm" class="space-y-4">
                <div>
                    <!-- Label removed -->
                    <textarea 
                        id="address" 
                        rows="2" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition resize-none"
                        placeholder="e.g. Kitty Hawk, North Carolina"
                        required></textarea>
                </div>

                <button 
                    type="submit" 
                    id="submitBtn"
                    class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>Get Coordinates</span>
                    <i class="ph ph-magnifying-glass"></i>
                </button>
            </form>

            <!-- Loading State -->
            <div id="loading" class="hidden mt-6 text-center text-gray-500 flex flex-col items-center">
                <div class="loader mb-2"></div>
                <p class="text-sm">Searching global database...</p>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden mt-6 bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <div class="flex items-center">
                    <i class="ph ph-warning-circle text-red-500 text-xl mr-2"></i>
                    <p class="text-red-700 font-medium" id="errorText">Address not found.</p>
                </div>
            </div>

            <!-- Result Card -->
            <div id="resultCard" class="hidden mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4 relative">
                
                <div class="space-y-3 mb-4">

                    <!-- Bubble 0: Found Address (Click to Copy) -->
                    <div id="addressBubble" class="group bg-white p-3 rounded shadow-sm border border-gray-100 cursor-pointer hover:bg-blue-50 hover:border-blue-200 transition relative">
                        <div class="flex justify-between items-start gap-2">
                            <p id="foundAddress" class="text-sm text-gray-700 italic leading-relaxed font-medium break-words"></p>
                            <i class="ph ph-copy text-gray-400 group-hover:text-blue-500 flex-shrink-0 mt-1"></i>
                        </div>
                        <div id="copyFeedbackAddress" class="hidden absolute top-[-30px] right-0 bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg z-10">Copied!</div>
                    </div>
                    
                    <!-- Bubble 1: DMS (Separate Lines) -->
                    <div id="dmsBubble" class="group bg-white p-3 rounded shadow-sm border border-gray-100 cursor-pointer hover:bg-blue-50 hover:border-blue-200 transition relative">
                        <div class="flex justify-between items-center h-full">
                            <div>
                                <!-- Label removed -->
                                <div class="font-mono font-bold text-gray-800 text-lg leading-tight">
                                    <div id="dmsLat" class="whitespace-pre">--</div>
                                    <div id="dmsLon" class="whitespace-pre">--</div>
                                </div>
                            </div>
                            <i class="ph ph-copy text-gray-400 group-hover:text-blue-500 flex-shrink-0 ml-auto"></i>
                        </div>
                        <div id="copyFeedbackDms" class="hidden absolute top-[-30px] right-0 bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg z-10">Copied!</div>
                    </div>

                    <!-- Bubble 2: ForeFlight (Decimal / Decimal) -->
                    <div id="foreflightBubble" class="group bg-white p-3 rounded shadow-sm border border-gray-100 cursor-pointer hover:bg-blue-50 hover:border-blue-200 transition relative">
                         <div class="flex justify-between items-center h-full">
                            <div>
                                <!-- Label removed -->
                                <div id="foreflightDisplay" class="font-mono font-bold text-blue-600 text-lg break-all">--</div>
                            </div>
                            <i class="ph ph-copy text-gray-400 group-hover:text-blue-500 flex-shrink-0 ml-auto"></i>
                        </div>
                        <div id="copyFeedbackForeflight" class="hidden absolute top-[-30px] right-0 bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg z-10">Copied!</div>
                    </div>

                </div>

                <!-- Map Links -->
                <div class="flex gap-2">
                    <a id="googleMapsLink" href="#" target="_blank" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded text-sm font-medium hover:bg-gray-50 text-center transition flex items-center justify-center gap-2">
                        <i class="ph ph-google-logo text-lg"></i>
                        Google Maps
                    </a>
                    <a id="osmLink" href="#" target="_blank" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded text-sm font-medium hover:bg-gray-50 text-center transition flex items-center justify-center gap-2">
                        <i class="ph ph-map-trifold text-lg"></i>
                        OSM
                    </a>
                </div>
            </div>
        </div>
        
        <div class="bg-gray-50 px-6 py-3 border-t border-gray-100">
            <p class="text-xs text-center text-gray-400">Powered by OpenStreetMap & Nominatim</p>
        </div>
    </div>

    <script>
        const form = document.getElementById('geoForm');
        const addressInput = document.getElementById('address');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const resultCard = document.getElementById('resultCard');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        const dmsLat = document.getElementById('dmsLat');
        const dmsLon = document.getElementById('dmsLon');
        const foreflightDisplay = document.getElementById('foreflightDisplay');
        
        const foundAddress = document.getElementById('foundAddress');
        const addressBubble = document.getElementById('addressBubble');
        const dmsBubble = document.getElementById('dmsBubble');
        const foreflightBubble = document.getElementById('foreflightBubble');

        const osmLink = document.getElementById('osmLink');
        const googleMapsLink = document.getElementById('googleMapsLink');

        function toDMS(coordinate, isLat) {
            const absolute = Math.abs(coordinate);
            const degrees = Math.floor(absolute);
            const minutesNotTruncated = (absolute - degrees) * 60;
            const minutes = Math.floor(minutesNotTruncated);
            const seconds = (minutesNotTruncated - minutes) * 60;
            
            const minutesStr = minutes.toString().padStart(2, '0');
            const secondsStr = seconds.toFixed(2).padStart(5, '0');

            let direction = "";
            let spacer = " "; // Default 1 space
            let degreesStr = degrees.toString();

            if (isLat) {
                direction = coordinate >= 0 ? "N" : "S";
                spacer = "  "; // 2 spaces for Latitude
            } else {
                direction = coordinate >= 0 ? "E" : "W";
                spacer = " "; // 1 space for Longitude
                degreesStr = degrees.toString().padStart(3, '0'); // Pad Longitude to 3 digits
            }

            // Using spacer variable combined with whitespace-pre class on the element
            return `${direction}${spacer}${degreesStr}Â° ${minutesStr}' ${secondsStr}"`;
        }

        function toForeFlightDecimal(lat, lon) {
            // ForeFlight typically accepts lat/lon (e.g. 34.2/-118.5)
            // Using 5 decimal places is generally sufficient for aviation precision
            return `${lat.toFixed(5)}/${lon.toFixed(5)}`;
        }

        // Generic Copy Function
        function setupCopy(element, textGetter, feedbackId) {
            const feedbackEl = document.getElementById(feedbackId);
            
            element.addEventListener('click', () => {
                const textToCopy = textGetter();
                
                if(textToCopy && !textToCopy.includes('--')) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        feedbackEl.classList.remove('hidden');
                        feedbackEl.classList.add('fade-in-out');
                        
                        setTimeout(() => {
                            feedbackEl.classList.add('hidden');
                            feedbackEl.classList.remove('fade-in-out');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
                }
            });
        }

        // Setup Copy Listeners
        setupCopy(addressBubble, () => foundAddress.textContent, 'copyFeedbackAddress');
        
        setupCopy(dmsBubble, () => {
            return `${dmsLat.textContent}\n${dmsLon.textContent}`;
        }, 'copyFeedbackDms');
        
        setupCopy(foreflightBubble, () => foreflightDisplay.textContent, 'copyFeedbackForeflight');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const address = addressInput.value.trim();
            
            if (!address) return;

            // Reset UI
            errorMessage.classList.add('hidden');
            resultCard.classList.add('hidden');
            loading.classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.querySelector('span').textContent = "Searching...";

            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`;

                const response = await fetch(url, {
                    headers: {
                        'Accept-Language': 'en-US,en;q=0.5' 
                    }
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();

                if (data.length === 0) {
                    throw new Error('Address could not be found. Please try being more specific.');
                }

                const result = data[0];
                const lat = parseFloat(result.lat);
                const lon = parseFloat(result.lon);

                // Bubble 1: DMS (Separate Lines with extra alignment space for Lat only)
                dmsLat.textContent = toDMS(lat, true);
                dmsLon.textContent = toDMS(lon, false);

                // Bubble 2: ForeFlight (Decimal)
                foreflightDisplay.textContent = toForeFlightDecimal(lat, lon);

                // Address Bubble
                foundAddress.textContent = result.display_name;
                
                // Map Links
                osmLink.href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=16/${lat}/${lon}`;
                googleMapsLink.href = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
                
                resultCard.classList.remove('hidden');

            } catch (error) {
                errorText.textContent = error.message;
                errorMessage.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.querySelector('span').textContent = "Get Coordinates";
            }
        });
    </script>
</body>
</html>
